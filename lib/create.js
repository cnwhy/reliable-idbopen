export default function create(global) {
    const dbMap = new Map();
    /**
     * 打开指定indexedDb数据库
     * @param dbName 库名
     * @param options 初始化参数
     * @returns Promise<IDBDatabase>
     */
    const idbOpen = async (dbName, { store, upgradeneeded } = {}) => {
        if (!dbName || typeof dbName !== "string") {
            return Promise.reject(new TypeError("dbName must be a string"));
        }
        // if (!version) {
        let db = dbMap.get(dbName);
        if (db) {
            try {
                return dbTest(await db);
            }
            catch (e) {
                return Promise.reject(e);
            }
        }
        let p = open();
        dbMap.set(dbName, p);
        return p;
        // }
        function upgradeneededTest(db, ts) {
            switch (typeof store) {
                case "string": {
                    let has = db.objectStoreNames.contains(store);
                    // has || console.log(`未找到名称为${store}的ObjectStore`);
                    return has;
                }
                case "function": {
                    return store.call(this, db, ts);
                }
                default:
                    return true;
            }
        }
        function dbTest(db) {
            if (upgradeneededTest(db, db.objectStoreNames.length
                ? db.transaction([...db.objectStoreNames], "readonly")
                : null)) {
                return Promise.resolve(db);
            }
            else {
                let v = (db.version || 1) + 1;
                return open(v);
                // return idbOpen(dbName, { store, version: v, upgradeneeded });
            }
        }
        function open(version) {
            return new Promise((resolve, reject) => {
                let request = global.indexedDB.open(dbName, version);
                // 请求数据库失败的回调函数
                request.onerror = function (_event) {
                    // console.log("打开数据库失败,错误信息为:", this.error);
                    reject(this.error);
                };
                let iserror = false;
                //版本更新的时候或者第一次打开数据库的时候
                request.onupgradeneeded = function (event) {
                    // console.log("进入 onupgradeneeded", request);
                    try {
                        const db = this.result;
                        const transaction = this.transaction;
                        if (typeof upgradeneeded === "function") {
                            upgradeneeded.call(this, db, transaction, event);
                            if (!upgradeneededTest.call(this, db, transaction)) {
                                throw new Error(`虽然已经执行了 upgradeneeded 更新数据库，但仍未通过 store 的检测`);
                            }
                        }
                        else if (typeof store === "string") {
                            if (!db.objectStoreNames.contains(store)) {
                                db.createObjectStore(store, {
                                    autoIncrement: true, //自动生成主键
                                });
                                // console.log("成功创建数据的ObjectStore", store);
                            }
                        }
                        else {
                            if (!upgradeneededTest.call(this, db, transaction)) {
                                throw new TypeError("缺少 upgradeneeded 参数");
                            }
                        }
                    }
                    catch (e) {
                        iserror = true;
                        reject(e);
                    }
                };
                // 请求数据库成功的回调函数
                request.onsuccess = function (_event) {
                    if (iserror)
                        return;
                    // console.log("onsuccess:", request.transaction);
                    const db = this.result;
                    dbMap.set(dbName, db);
                    resolve(dbTest(db));
                    db.onversionchange = function () {
                        // console.log("onversionchange");
                        db.close();
                        dbMap.delete(dbName);
                    };
                    db.onclose = function () {
                        // console.log("onclose");
                        dbMap.delete(dbName);
                    };
                };
                request.onblocked = function (_event) {
                    console.log('onblocked');
                    let db = dbMap.get(dbName);
                    if (db)
                        db?.close?.();
                };
            });
        }
    };
    const idbDelete = (dbName) => {
        return new Promise((resolve, reject) => {
            let request = global.indexedDB.deleteDatabase(dbName);
            // 请求数据库失败的回调函数
            request.onerror = function (err) {
                // console.log("删除数据库失败,错误信息为:", err);
                reject(err);
            };
            // 请求数据库成功的回调函数
            request.onsuccess = function (_event) {
                // console.log("删除数据库成功");
                dbMap.delete(dbName);
                resolve(null);
            };
            request.onblocked = function (_event) {
                // console.log("上一次的数据库未关闭");
                let db = dbMap.get(dbName);
                if (db)
                    db.close();
            };
        });
    };
    return { idbOpen, idbDelete };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NyZWF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFnQkEsTUFBTSxDQUFDLE9BQU8sVUFBVSxNQUFNLENBQUMsTUFBYztJQUN6QyxNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBRXhCOzs7OztPQUtHO0lBQ0gsTUFBTSxPQUFPLEdBSWUsS0FBSyxFQUM3QixNQUFNLEVBQ04sRUFBRSxLQUFLLEVBQUUsYUFBYSxFQUFFLEdBQUcsRUFBRSxFQUMvQixFQUFFO1FBQ0EsSUFBSSxDQUFDLE1BQU0sSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLEVBQUU7WUFDdkMsT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksU0FBUyxDQUFDLHlCQUF5QixDQUFDLENBQUMsQ0FBQztTQUNuRTtRQUVELGtCQUFrQjtRQUNsQixJQUFJLEVBQUUsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzNCLElBQUksRUFBRSxFQUFFO1lBQ0osSUFBSTtnQkFDQSxPQUFPLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO2FBQzNCO1lBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ1IsT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQzVCO1NBQ0o7UUFDRCxJQUFJLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQztRQUNmLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JCLE9BQU8sQ0FBQyxDQUFDO1FBQ1QsSUFBSTtRQUVKLFNBQVMsaUJBQWlCLENBRXRCLEVBQWUsRUFDZixFQUFtQjtZQUVuQixRQUFRLE9BQU8sS0FBSyxFQUFFO2dCQUNsQixLQUFLLFFBQVEsQ0FBQyxDQUFDO29CQUNYLElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBQzlDLG9EQUFvRDtvQkFDcEQsT0FBTyxHQUFHLENBQUM7aUJBQ2Q7Z0JBQ0QsS0FBSyxVQUFVLENBQUMsQ0FBQztvQkFDYixPQUNJLEtBSUgsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztpQkFDeEI7Z0JBQ0Q7b0JBQ0ksT0FBTyxJQUFJLENBQUM7YUFDbkI7UUFDTCxDQUFDO1FBRUQsU0FBUyxNQUFNLENBQUMsRUFBZTtZQUMzQixJQUNJLGlCQUFpQixDQUNiLEVBQUUsRUFDRixFQUFFLENBQUMsZ0JBQWdCLENBQUMsTUFBTTtnQkFDdEIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLFVBQVUsQ0FBQztnQkFDdEQsQ0FBQyxDQUFDLElBQUksQ0FDYixFQUNIO2dCQUNFLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUM5QjtpQkFBTTtnQkFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUM5QixPQUFPLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDZixnRUFBZ0U7YUFDbkU7UUFDTCxDQUFDO1FBRUQsU0FBUyxJQUFJLENBQUMsT0FBUTtZQUNsQixPQUFPLElBQUksT0FBTyxDQUFjLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO2dCQUNoRCxJQUFJLE9BQU8sR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQ3JELGVBQWU7Z0JBQ2YsT0FBTyxDQUFDLE9BQU8sR0FBRyxVQUFVLE1BQU07b0JBQzlCLDZDQUE2QztvQkFDN0MsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDdkIsQ0FBQyxDQUFDO2dCQUNGLElBQUksT0FBTyxHQUFHLEtBQUssQ0FBQztnQkFDcEIsc0JBQXNCO2dCQUN0QixPQUFPLENBQUMsZUFBZSxHQUFHLFVBQVUsS0FBSztvQkFDckMsOENBQThDO29CQUM5QyxJQUFJO3dCQUNBLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7d0JBQ3ZCLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7d0JBQ3JDLElBQUksT0FBTyxhQUFhLEtBQUssVUFBVSxFQUFFOzRCQUNyQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsV0FBVyxFQUFFLEtBQUssQ0FBQyxDQUFDOzRCQUNqRCxJQUNJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsV0FBVyxDQUFDLEVBQ2hEO2dDQUNFLE1BQU0sSUFBSSxLQUFLLENBQ1gsNkNBQTZDLENBQ2hELENBQUM7NkJBQ0w7eUJBQ0o7NkJBQU0sSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUU7NEJBQ2xDLElBQUksQ0FBQyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFO2dDQUN0QyxFQUFFLENBQUMsaUJBQWlCLENBQUMsS0FBSyxFQUFFO29DQUN4QixhQUFhLEVBQUUsSUFBSSxFQUFFLFFBQVE7aUNBQ2hDLENBQUMsQ0FBQztnQ0FDSCw0Q0FBNEM7NkJBQy9DO3lCQUNKOzZCQUFNOzRCQUNILElBQ0ksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUUsRUFBRSxXQUFXLENBQUMsRUFDaEQ7Z0NBQ0UsTUFBTSxJQUFJLFNBQVMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDOzZCQUM5Qzt5QkFDSjtxQkFDSjtvQkFBQyxPQUFPLENBQUMsRUFBRTt3QkFDUixPQUFPLEdBQUcsSUFBSSxDQUFDO3dCQUNmLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztxQkFDYjtnQkFDTCxDQUFDLENBQUM7Z0JBQ0YsZUFBZTtnQkFDZixPQUFPLENBQUMsU0FBUyxHQUFHLFVBQVUsTUFBTTtvQkFDaEMsSUFBSSxPQUFPO3dCQUFFLE9BQU87b0JBQ3BCLGtEQUFrRDtvQkFDbEQsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztvQkFDdkIsS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7b0JBQ3RCLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDcEIsRUFBRSxDQUFDLGVBQWUsR0FBRzt3QkFDakIsa0NBQWtDO3dCQUNsQyxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUM7d0JBQ1gsS0FBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztvQkFDekIsQ0FBQyxDQUFDO29CQUNGLEVBQUUsQ0FBQyxPQUFPLEdBQUc7d0JBQ1QsMEJBQTBCO3dCQUMxQixLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUN6QixDQUFDLENBQUM7Z0JBQ04sQ0FBQyxDQUFDO2dCQUNGLE9BQU8sQ0FBQyxTQUFTLEdBQUcsVUFBVSxNQUFNO29CQUNoQyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO29CQUN6QixJQUFJLEVBQUUsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUMzQixJQUFJLEVBQUU7d0JBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUM7Z0JBQzFCLENBQUMsQ0FBQztZQUNOLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztJQUNMLENBQUMsQ0FBQztJQUVGLE1BQU0sU0FBUyxHQUFHLENBQUMsTUFBYyxFQUFFLEVBQUU7UUFDakMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNuQyxJQUFJLE9BQU8sR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN0RCxlQUFlO1lBQ2YsT0FBTyxDQUFDLE9BQU8sR0FBRyxVQUFVLEdBQUc7Z0JBQzNCLHNDQUFzQztnQkFDdEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2hCLENBQUMsQ0FBQztZQUNGLGVBQWU7WUFDZixPQUFPLENBQUMsU0FBUyxHQUFHLFVBQVUsTUFBTTtnQkFDaEMsMEJBQTBCO2dCQUMxQixLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUNyQixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDbEIsQ0FBQyxDQUFDO1lBQ0YsT0FBTyxDQUFDLFNBQVMsR0FBRyxVQUFVLE1BQU07Z0JBQ2hDLDZCQUE2QjtnQkFDN0IsSUFBSSxFQUFFLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDM0IsSUFBSSxFQUFFO29CQUFFLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUN2QixDQUFDLENBQUM7UUFDTixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQztJQUNGLE9BQU8sRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLENBQUM7QUFDbEMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCB0eXBlIEluaXRPcHRpb25zID0ge1xuICAgIC8qKiDlrZjlgqjlupPlkI3np7Ag5oiW6ICF55So5LqO5qOA5rWL5piv5ZCm6ZyA6KaB5pu05paw5pWw5o2u5pWw55qE5Ye95pWwLOi/lOWbniB0cnVlIOWImeS4jeaWsCwg5ZCm5YiZ5omn6KGMIHVwZ3JhZGVuZWVkZWQgKi9cbiAgICBzdG9yZT86IHN0cmluZyB8ICgoZGI6IElEQkRhdGFiYXNlLCB0cz86IElEQlRyYW5zYWN0aW9uKSA9PiBib29sZWFuKTtcbiAgICAvKipcbiAgICAgKiDmm7TmlrDmlbDmja7lupNcbiAgICAgKiBAcGFyYW0gZGIgSURCRGF0YWJhc2VcbiAgICAgKiBAcGFyYW0gZXZlbnQgb251cGdyYWRlbmVlZGVk55qE5LqL5Lu25a+55YOPXG4gICAgICovXG4gICAgdXBncmFkZW5lZWRlZD86IChcbiAgICAgICAgdGhpczogSURCT3BlbkRCUmVxdWVzdCxcbiAgICAgICAgZGI6IElEQkRhdGFiYXNlLFxuICAgICAgICB0YzogSURCVHJhbnNhY3Rpb24sXG4gICAgICAgIGV2ZW50OiBJREJWZXJzaW9uQ2hhbmdlRXZlbnRcbiAgICApID0+IHZvaWQ7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBjcmVhdGUoZ2xvYmFsOiBXaW5kb3cpIHtcbiAgICBjb25zdCBkYk1hcCA9IG5ldyBNYXAoKTtcblxuICAgIC8qKlxuICAgICAqIOaJk+W8gOaMh+WummluZGV4ZWREYuaVsOaNruW6k1xuICAgICAqIEBwYXJhbSBkYk5hbWUg5bqT5ZCNXG4gICAgICogQHBhcmFtIG9wdGlvbnMg5Yid5aeL5YyW5Y+C5pWwXG4gICAgICogQHJldHVybnMgUHJvbWlzZTxJREJEYXRhYmFzZT5cbiAgICAgKi9cbiAgICBjb25zdCBpZGJPcGVuOiAoXG4gICAgICAgIC8qKiAqL1xuICAgICAgICBkYk5hbWU6IHN0cmluZyxcbiAgICAgICAgb3B0aW9ucz86IEluaXRPcHRpb25zXG4gICAgKSA9PiBQcm9taXNlPElEQkRhdGFiYXNlPiA9IGFzeW5jIChcbiAgICAgICAgZGJOYW1lLFxuICAgICAgICB7IHN0b3JlLCB1cGdyYWRlbmVlZGVkIH0gPSB7fVxuICAgICkgPT4ge1xuICAgICAgICBpZiAoIWRiTmFtZSB8fCB0eXBlb2YgZGJOYW1lICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IFR5cGVFcnJvcihcImRiTmFtZSBtdXN0IGJlIGEgc3RyaW5nXCIpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGlmICghdmVyc2lvbikge1xuICAgICAgICBsZXQgZGIgPSBkYk1hcC5nZXQoZGJOYW1lKTtcbiAgICAgICAgaWYgKGRiKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHJldHVybiBkYlRlc3QoYXdhaXQgZGIpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBsZXQgcCA9IG9wZW4oKTtcbiAgICAgICAgZGJNYXAuc2V0KGRiTmFtZSwgcCk7XG4gICAgICAgIHJldHVybiBwO1xuICAgICAgICAvLyB9XG5cbiAgICAgICAgZnVuY3Rpb24gdXBncmFkZW5lZWRlZFRlc3QoXG4gICAgICAgICAgICB0aGlzOiBhbnksXG4gICAgICAgICAgICBkYjogSURCRGF0YWJhc2UsXG4gICAgICAgICAgICB0cz86IElEQlRyYW5zYWN0aW9uXG4gICAgICAgICkge1xuICAgICAgICAgICAgc3dpdGNoICh0eXBlb2Ygc3RvcmUpIHtcbiAgICAgICAgICAgICAgICBjYXNlIFwic3RyaW5nXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGhhcyA9IGRiLm9iamVjdFN0b3JlTmFtZXMuY29udGFpbnMoc3RvcmUpO1xuICAgICAgICAgICAgICAgICAgICAvLyBoYXMgfHwgY29uc29sZS5sb2coYOacquaJvuWIsOWQjeensOS4uiR7c3RvcmV955qET2JqZWN0U3RvcmVgKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhhcztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY2FzZSBcImZ1bmN0aW9uXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0b3JlIGFzIChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYjogSURCRGF0YWJhc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHM/OiBJREJUcmFuc2FjdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgKSA9PiBib29sZWFuXG4gICAgICAgICAgICAgICAgICAgICkuY2FsbCh0aGlzLCBkYiwgdHMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGRiVGVzdChkYjogSURCRGF0YWJhc2UpIHtcbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICB1cGdyYWRlbmVlZGVkVGVzdChcbiAgICAgICAgICAgICAgICAgICAgZGIsXG4gICAgICAgICAgICAgICAgICAgIGRiLm9iamVjdFN0b3JlTmFtZXMubGVuZ3RoXG4gICAgICAgICAgICAgICAgICAgICAgICA/IGRiLnRyYW5zYWN0aW9uKFsuLi5kYi5vYmplY3RTdG9yZU5hbWVzXSwgXCJyZWFkb25seVwiKVxuICAgICAgICAgICAgICAgICAgICAgICAgOiBudWxsXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShkYik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxldCB2ID0gKGRiLnZlcnNpb24gfHwgMSkgKyAxO1xuICAgICAgICAgICAgICAgIHJldHVybiBvcGVuKHYpO1xuICAgICAgICAgICAgICAgIC8vIHJldHVybiBpZGJPcGVuKGRiTmFtZSwgeyBzdG9yZSwgdmVyc2lvbjogdiwgdXBncmFkZW5lZWRlZCB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIG9wZW4odmVyc2lvbj8pIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxJREJEYXRhYmFzZT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCByZXF1ZXN0ID0gZ2xvYmFsLmluZGV4ZWREQi5vcGVuKGRiTmFtZSwgdmVyc2lvbik7XG4gICAgICAgICAgICAgICAgLy8g6K+35rGC5pWw5o2u5bqT5aSx6LSl55qE5Zue6LCD5Ye95pWwXG4gICAgICAgICAgICAgICAgcmVxdWVzdC5vbmVycm9yID0gZnVuY3Rpb24gKF9ldmVudCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIuaJk+W8gOaVsOaNruW6k+Wksei0pSzplJnor6/kv6Hmga/kuLo6XCIsIHRoaXMuZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICByZWplY3QodGhpcy5lcnJvcik7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBsZXQgaXNlcnJvciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIC8v54mI5pys5pu05paw55qE5pe25YCZ5oiW6ICF56ys5LiA5qyh5omT5byA5pWw5o2u5bqT55qE5pe25YCZXG4gICAgICAgICAgICAgICAgcmVxdWVzdC5vbnVwZ3JhZGVuZWVkZWQgPSBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCLov5vlhaUgb251cGdyYWRlbmVlZGVkXCIsIHJlcXVlc3QpO1xuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGIgPSB0aGlzLnJlc3VsdDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gdGhpcy50cmFuc2FjdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdXBncmFkZW5lZWRlZCA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBncmFkZW5lZWRlZC5jYWxsKHRoaXMsIGRiLCB0cmFuc2FjdGlvbiwgZXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIXVwZ3JhZGVuZWVkZWRUZXN0LmNhbGwodGhpcywgZGIsIHRyYW5zYWN0aW9uKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBg6Jm954S25bey57uP5omn6KGM5LqGIHVwZ3JhZGVuZWVkZWQg5pu05paw5pWw5o2u5bqT77yM5L2G5LuN5pyq6YCa6L+HIHN0b3JlIOeahOajgOa1i2BcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdG9yZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZGIub2JqZWN0U3RvcmVOYW1lcy5jb250YWlucyhzdG9yZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGIuY3JlYXRlT2JqZWN0U3RvcmUoc3RvcmUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9JbmNyZW1lbnQ6IHRydWUsIC8v6Ieq5Yqo55Sf5oiQ5Li76ZSuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIuaIkOWKn+WIm+W7uuaVsOaNrueahE9iamVjdFN0b3JlXCIsIHN0b3JlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIXVwZ3JhZGVuZWVkZWRUZXN0LmNhbGwodGhpcywgZGIsIHRyYW5zYWN0aW9uKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwi57y65bCRIHVwZ3JhZGVuZWVkZWQg5Y+C5pWwXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXNlcnJvciA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIC8vIOivt+axguaVsOaNruW6k+aIkOWKn+eahOWbnuiwg+WHveaVsFxuICAgICAgICAgICAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gZnVuY3Rpb24gKF9ldmVudCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXNlcnJvcikgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIm9uc3VjY2VzczpcIiwgcmVxdWVzdC50cmFuc2FjdGlvbik7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRiID0gdGhpcy5yZXN1bHQ7XG4gICAgICAgICAgICAgICAgICAgIGRiTWFwLnNldChkYk5hbWUsIGRiKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYlRlc3QoZGIpKTtcbiAgICAgICAgICAgICAgICAgICAgZGIub252ZXJzaW9uY2hhbmdlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCJvbnZlcnNpb25jaGFuZ2VcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBkYi5jbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGJNYXAuZGVsZXRlKGRiTmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGRiLm9uY2xvc2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIm9uY2xvc2VcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBkYk1hcC5kZWxldGUoZGJOYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHJlcXVlc3Qub25ibG9ja2VkID0gZnVuY3Rpb24gKF9ldmVudCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnb25ibG9ja2VkJyk7XG4gICAgICAgICAgICAgICAgICAgIGxldCBkYiA9IGRiTWFwLmdldChkYk5hbWUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGIpIGRiPy5jbG9zZT8uKCk7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IGlkYkRlbGV0ZSA9IChkYk5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgbGV0IHJlcXVlc3QgPSBnbG9iYWwuaW5kZXhlZERCLmRlbGV0ZURhdGFiYXNlKGRiTmFtZSk7XG4gICAgICAgICAgICAvLyDor7fmsYLmlbDmja7lupPlpLHotKXnmoTlm57osIPlh73mlbBcbiAgICAgICAgICAgIHJlcXVlc3Qub25lcnJvciA9IGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIuWIoOmZpOaVsOaNruW6k+Wksei0pSzplJnor6/kv6Hmga/kuLo6XCIsIGVycik7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgLy8g6K+35rGC5pWw5o2u5bqT5oiQ5Yqf55qE5Zue6LCD5Ye95pWwXG4gICAgICAgICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9IGZ1bmN0aW9uIChfZXZlbnQpIHtcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIuWIoOmZpOaVsOaNruW6k+aIkOWKn1wiKTtcbiAgICAgICAgICAgICAgICBkYk1hcC5kZWxldGUoZGJOYW1lKTtcbiAgICAgICAgICAgICAgICByZXNvbHZlKG51bGwpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHJlcXVlc3Qub25ibG9ja2VkID0gZnVuY3Rpb24gKF9ldmVudCkge1xuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwi5LiK5LiA5qyh55qE5pWw5o2u5bqT5pyq5YWz6ZetXCIpO1xuICAgICAgICAgICAgICAgIGxldCBkYiA9IGRiTWFwLmdldChkYk5hbWUpO1xuICAgICAgICAgICAgICAgIGlmIChkYikgZGIuY2xvc2UoKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgIH07XG4gICAgcmV0dXJuIHsgaWRiT3BlbiwgaWRiRGVsZXRlIH07XG59Il19